---
title: "spacesavers2 ðŸš€ report"
author: "CCR Collaborative Bioinformatics Resource"
format:
  html:
    theme: bslib
    embed-resources: true
    toc: true
    code-fold: true
---

```{r deps}
library(bslib)
library(dplyr)
library(ggplot2)
library(here)
library(lubridate)
library(purrr)
library(readr)
library(stringr)
library(tidyr)
```


```{r userdata}
input_dir <- here('data','20230925') # '/data/CCBR_Pipeliner/userdata/spacesavers2/'
aggregated_filetypes <- c('blamematrix','catalog','mimeo')
user_dat <- tibble(filename = list.files(input_dir, full.names = TRUE)) %>%
  filter(!str_detect(filename, paste(aggregated_filetypes, collapse = '|'))) %>%
  separate_wider_delim(filename, delim = '.', cols_remove = FALSE,
                       names = c("date", 'path', 'username', 'file', 'ext')) %>%

  filter(str_detect(ext, "tsv|txt")) %>%
  mutate(date = as_date(basename(date)))
```

```{r plot_summary_single}
users <- c('sovacoolkl', 'kopardevn')
dates <- as_date('2023-09-25')
metrics <- c('DuplicatesFiles','OverallScore','TotalFiles')
user_dat %>%
  filter(username %in% users, date %in% dates, file == 'summary') %>%
  pull(filename) %>%
  map(function(x) { read_tsv(x) %>% mutate(filename = x)}) %>%
  list_rbind() %>%
  separate_wider_delim(filename, delim = '.', cols_remove = FALSE,
                       names = c("date", 'path', 'username', 'file', 'ext')) %>%
  pivot_longer(where(is.numeric), names_to = 'metric') %>%
  filter(metric %in% metrics) %>%
  ggplot(aes(value, path, color = username)) +
  geom_boxplot() +
  facet_grid(~metric, scales = 'free')
```
